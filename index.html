<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UWorld to Anki Tag Converter</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>UWorld to Anki Tag Converter</h1>

        <!-- Input Section -->
        <label for="input_ids">Input Question IDs (comma-separated):</label>
        <textarea id="input_ids" rows="4" placeholder="e.g., 23596, 25401, 23175"></textarea>

        <!-- Generate Button -->
        <button id="generate_list">Generate List</button>

        <!-- Mode Selection -->
        <div id="mode_section">
            <label><input type="radio" name="mode" value="All" checked> All</label>
            <label><input type="radio" name="mode" value="Select Questions"> Selected Questions</label>
            <label><input type="radio" name="mode" value="Exclude Questions"> Exclude Questions</label>
        </div>

        <!-- Generated Questions -->
        <h2>Generated Questions</h2>
        <div id="question_list" class="question-list"></div>

        <!-- Output Section -->
        <button id="generate_output">Generate Output</button>
        <label for="output_text">Generated Output:</label>
        <textarea id="output_text" rows="5" readonly></textarea>
    </div>

    <script>
        // Generate List: Splits input IDs and groups into columns of 10
        document.getElementById("generate_list").addEventListener("click", () => {
            const inputIDs = document.getElementById("input_ids").value.trim();
            const questionList = document.getElementById("question_list");
            questionList.innerHTML = "";

            if (!inputIDs) {
                alert("Please enter question IDs.");
                return;
            }

            const ids = inputIDs.split(",").map(id => id.trim()).filter(id => id);
            const columns = [];
            const numColumns = Math.ceil(ids.length / 10);

            // Create columns and append checkboxes
            for (let i = 0; i < numColumns; i++) {
                const columnDiv = document.createElement("div");
                columnDiv.className = "question-column";
                const start = i * 10;
                const end = Math.min(start + 10, ids.length);

                for (let j = start; j < end; j++) {
                    const label = document.createElement("label");
                    label.innerHTML = `<input type="checkbox" value="${j + 1}"> ${j + 1}. ${ids[j]}`;
                    columnDiv.appendChild(label);
                    columnDiv.appendChild(document.createElement("br"));
                }

                columns.push(columnDiv);
                questionList.appendChild(columnDiv);
            }
        });

        // Generate Output: Sends selected indices and mode to the Netlify function
        document.getElementById("generate_output").addEventListener("click", async () => {
            const inputIDs = document.getElementById("input_ids").value.trim();
            const mode = document.querySelector("input[name='mode']:checked").value;
            const selectedIndices = Array.from(document.querySelectorAll("#question_list input:checked"))
                                         .map(input => input.value);

            try {
                const response = await fetch("/.netlify/functions/process", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ids: inputIDs, mode: mode, selected_numbers: selectedIndices })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById("output_text").value = JSON.stringify(data.output, null, 2);
                } else {
                    const error = await response.json();
                    alert(error.error || "An error occurred.");
                }
            } catch (error) {
                alert("Failed to communicate with the server. Please try again.");
            }
        });
    </script>
</body>
</html>
